<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <title>BookTrack - Online Library management system</title>

    <!-- Bootstrap core CSS -->
    <link href="/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">


    <!-- Additional CSS Files -->
    <link rel="stylesheet" href="/assets/css/fontawesome.css">
    <link rel="stylesheet" href="/assets/css/templatemo-scholar.css">
    <link rel="stylesheet" href="/assets/css/owl.css">
    <link rel="stylesheet" href="/assets/css/animate.css">
    <link rel="stylesheet" href="https://unpkg.com/swiper@7/swiper-bundle.min.css"/>
    <!--


    TemplateMo 586 Scholar

    https://templatemo.com/tm-586-scholar

    -->

    <style>
        .text-truncate-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .text-truncate-4 {
            display: -webkit-box;
            -webkit-line-clamp: 4;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>

</head>

<body>

<!-- ***** Preloader Start ***** -->
<div id="js-preloader" class="js-preloader">
    <div class="preloader-inner">
        <span class="dot"></span>
        <div class="dots">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </div>
</div>
<!-- ***** Preloader End ***** -->

<!-- ***** Header Area Start ***** -->
<header class="header-area header-sticky">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <nav class="main-nav">
                    <!-- ***** Logo Start ***** -->
                    <a th:href="@{/}" class="logo">
                        <h1>BookTrack</h1>
                    </a>
                    <!-- ***** Logo End ***** -->
                    <!-- ***** Serach Start ***** -->
                    <div class="search-input">
                        <form id="search" action="#">
                            <input type="text" placeholder="Type Something" id='searchText' name="searchKeyword" onkeypress="handle" />
                            <i class="fa fa-search"></i>
                        </form>
                    </div>
                    <!-- ***** Serach Start ***** -->
                    <!-- ***** Menu Start ***** -->
                    <ul class="nav">
                        <li class="scroll-to-section"><a th:href="@{/home}">Home</a></li>
                        <li class="scroll-to-section"><a th:href="@{/library}">Books</a></li>
                        <li class="scroll-to-section"><a th:href="@{/profile}">Profile</a></li>
                        <li class="scroll-to-section"><a href="#contact">Contact Us</a></li>
                        <li class="scroll-to-section" th:if="${not #authorization.expression('isAuthenticated()')}">
                            <a th:href="@{/login}">Login</a>
                        </li>
                    </ul>
                    <a class='menu-trigger'>
                        <span>Menu</span>
                    </a>
                    <!-- ***** Menu End ***** -->
                </nav>
            </div>
        </div>
    </div>
</header>
<!-- ***** Header Area End ***** -->

<div class="main-banner" id="top">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="owl-carousel owl-banner">
                    <div class="item item-1">
                        <div class="header-text">
                            <span class="category">Our Courses</span>
                            <h2>With Scholar Teachers, Everything Is Easier</h2>
                            <p>Scholar is free CSS template designed by TemplateMo for online educational related websites. This layout is based on the famous Bootstrap v5.3.0 framework.</p>
                            <div class="buttons">
                                <div class="main-button">
                                    <a href="#">Request Demo</a>
                                </div>
                                <div class="icon-button">
                                    <a href="#"><i class="fa fa-play"></i> What's Scholar?</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="item item-2">
                        <div class="header-text">
                            <span class="category">Best Result</span>
                            <h2>Get the best result out of your effort</h2>
                            <p>You are allowed to use this template for any educational or commercial purpose. You are not allowed to re-distribute the template ZIP file on any other website.</p>
                            <div class="buttons">
                                <div class="main-button">
                                    <a href="#">Request Demo</a>
                                </div>
                                <div class="icon-button">
                                    <a href="#"><i class="fa fa-play"></i> What's the best result?</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="item item-3">
                        <div class="header-text">
                            <span class="category">Online Learning</span>
                            <h2>Online Learning helps you save the time</h2>
                            <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod temporious incididunt ut labore et dolore magna aliqua suspendisse.</p>
                            <div class="buttons">
                                <div class="main-button">
                                    <a href="#">Request Demo</a>
                                </div>
                                <div class="icon-button">
                                    <a href="#"><i class="fa fa-play"></i> What's Online Course?</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="services section" id="services">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8 col-md-10 mb-4">
                <div class="service-item">
                    <div class="row">
                        <!-- Book Image Column -->
                        <div class="col-md-4 mb-4 mb-md-0">
                            <div class="text-center">
                                <img id="bookImage" src="" alt="Book Cover" class="img-fluid rounded shadow" style="max-height: 400px; width: auto;" />
                            </div>
                        </div>
                        <!-- Book Details Column -->
                        <div class="col-md-8">
                            <div class="main-content">
                                <h4 id="bookTitle" class="text-truncate-2"></h4>
                                <h6 id="bookAuthor" class="text-muted mb-3"></h6>
                                <p id="bookDescription" class="text-truncate-4"></p>
                                <div class="mt-3">
                                    <p><strong>Category:</strong> <span id="bookCategory"></span></p>
                                    <p><strong>Published:</strong> <span id="bookYear"></span></p>
                                    <p><strong>Pages:</strong> <span id="bookPages"></span></p>
                                    <p><strong>Available:</strong> <span id="bookAvailable"></span></p>
                                </div>
                                <!-- Reservation Controls -->
                                <div id="reservationControls" class="mt-4">
                                    <button id="reserveButton" class="btn btn-success">Reserve This Book</button>
                                    <p id="alreadyReservedMessage" class="text-info" style="display:none;">
                                        You already reserved this book. <a href="/profile">See my reservations</a>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Reviews Section -->
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10">
            <div class="mt-4">
                <h5>Leave a Review</h5>
                <form id="reviewForm">
                    <div class="mb-3">
                        <label for="reviewComment" class="form-label">Comment</label>
                        <textarea id="reviewComment" class="form-control" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="reviewRating" class="form-label">Rating (1-5)</label>
                        <input type="number" id="reviewRating" class="form-control" min="1" max="5" required />
                    </div>
                    <button type="submit" class="btn btn-primary">Submit Review</button>
                </form>
            </div>

            <div id="reviewsList" class="mt-4"></div>
        </div>
    </div>
</div>

<footer>
    <div class="container">
        <div class="col-lg-12">
            <p>Copyright Â© 2025 Unemployed Backenders. All rights reserved.</p>
        </div>
    </div>
</footer>

<!-- Scripts -->
<!-- Bootstrap core JavaScript -->
<script src="/vendor/jquery/jquery.min.js"></script>
<script src="/vendor/bootstrap/js/bootstrap.min.js"></script>
<script src="/assets/js/isotope.min.js"></script>
<script src="/assets/js/owl-carousel.js"></script>
<script src="/assets/js/counter.js"></script>
<script src="/assets/js/custom.js"></script>

<script>
    let isEditing = false;
    let editingReviewId = null;

    async function getCurrentUserId() {
        try {
            const response = await fetch('/users/me');
            if (!response.ok) throw new Error("User not authenticated");
            return await response.json();
        } catch (err) {
            console.error("Failed to get user ID:", err);
            return null;
        }
    }

    async function fetchBookDetails() {
        const path = window.location.pathname;
        const bookId = path.split('/').pop();

        try {
            const response = await fetch(`/books/${bookId}`);
            if (!response.ok) throw new Error("Book not found");

            const book = await response.json();

            document.getElementById('bookTitle').textContent = book.title;
            document.getElementById('bookAuthor').textContent = book.author;
            document.getElementById('bookDescription').textContent = book.description;
            document.getElementById('bookYear').textContent = book.publicationYear;
            document.getElementById('bookPages').textContent = book.pages;
            document.getElementById('bookAvailable').textContent = book.available;
            document.getElementById('bookCategory').textContent = book.category;

            const bookImage = document.getElementById('bookImage');
            bookImage.src = book.image || '/assets/images/default-book-cover.jpg';
            bookImage.alt = `Cover of ${book.title}`;

            document.getElementById("js-preloader").style.display = "none";

            // Check reservation status
            await checkReservationStatus(bookId);

            // Load reviews
            await loadReviews(bookId);

        } catch (err) {
            console.error(err);
            document.querySelector(".services .container").innerHTML =
                `<p class="text-danger text-center mt-5">Failed to load book details.</p>`;
        }
    }

    async function checkReservationStatus(bookId) {
        const userId = await getCurrentUserId();
        if (!userId) return;

        try {
            const response = await fetch(`/reservations/user/${userId}/active`);
            const reservations = await response.json();
            const alreadyReserved = reservations.some(r => r.bookId == bookId);

            if (alreadyReserved) {
                document.getElementById('reserveButton').style.display = 'none';
                document.getElementById('alreadyReservedMessage').style.display = 'block';
            }
        } catch (err) {
            console.error('Reservation check failed:', err);
        }
    }

    async function loadReviews(bookId) {
        try {
            const currentUserId = await getCurrentUserId();
            const response = await fetch(`/reviews/book/${bookId}`);
            if (!response.ok) throw new Error("Reviews not found");

            const reviews = await response.json();
            const container = document.getElementById('reviewsList');
            container.innerHTML = '';

            if (reviews.length === 0) {
                container.innerHTML = '<p class="text-muted">No reviews yet.</p>';
                return;
            }

            reviews.forEach(review => {
                const div = document.createElement('div');
                div.classList.add('card', 'mb-3');

                let actionButtons = '';
                if (review.userId === currentUserId) {
                    actionButtons = `
                        <button class="btn btn-sm btn-warning me-2" onclick="editReview(${review.id}, '${review.comment}', ${review.rating})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteReview(${review.id})">Delete</button>
                    `;
                }

                div.innerHTML = `
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-primary">${review.userName}</h6>
                        <p class="card-text">${review.comment}</p>
                        <p class="card-text"><small class="text-warning">Rating: ${review.rating} / 5</small></p>
                        ${actionButtons}
                    </div>
                `;

                container.appendChild(div);
            });
        } catch (err) {
            console.error('Error loading reviews:', err);
        }
    }

    function editReview(id, comment, rating) {
        isEditing = true;
        editingReviewId = id;

        document.getElementById('reviewComment').value = comment;
        document.getElementById('reviewRating').value = rating;

        const submitButton = document.querySelector('#reviewForm button');
        submitButton.textContent = "Update Review";
        submitButton.classList.remove('btn-primary');
        submitButton.classList.add('btn-success');
    }

    async function deleteReview(id) {
        if (!confirm("Are you sure you want to delete this review?")) return;

        try {
            const response = await fetch(`/reviews/${id}`, { method: 'DELETE' });
            if (!response.ok) throw new Error("Delete failed");

            await loadReviews(window.location.pathname.split('/').pop());
        } catch (err) {
            console.error("Delete failed:", err);
            alert("Failed to delete review.");
        }
    }

    // Event Listeners
    document.addEventListener("DOMContentLoaded", fetchBookDetails);

    // Review form submission
    document.getElementById('reviewForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const userId = await getCurrentUserId();
        if (!userId) {
            alert("You must be logged in to submit a review.");
            return;
        }

        const path = window.location.pathname;
        const bookId = path.split('/').pop();
        const comment = document.getElementById('reviewComment').value;
        const rating = parseInt(document.getElementById('reviewRating').value);

        try {
            let response;
            if (isEditing) {
                response = await fetch(`/reviews/${editingReviewId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ comment, rating })
                });
            } else {
                response = await fetch(`/reviews`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, bookId, comment, rating })
                });
            }

            if (!response.ok) throw new Error("Failed to submit review");

            // Reset form
            document.getElementById('reviewForm').reset();
            const submitButton = document.querySelector('#reviewForm button');
            submitButton.textContent = "Submit Review";
            submitButton.classList.remove('btn-success');
            submitButton.classList.add('btn-primary');
            isEditing = false;
            editingReviewId = null;

            await loadReviews(bookId);
        } catch (err) {
            console.error('Submit failed:', err);
            alert('Failed to submit review.');
        }
    });

    // Reservation button event listener
    document.getElementById('reserveButton').addEventListener('click', async () => {
        const userId = await getCurrentUserId();
        if (!userId) {
            alert("You must be logged in to reserve a book.");
            return;
        }

        const bookId = parseInt(window.location.pathname.split('/').pop());
        const now = new Date();
        const due = new Date();
        due.setDate(now.getDate() + 10);

        const startDate = now.toISOString().split('.')[0];
        const dueDate = due.toISOString().split('.')[0];

        try {
            const response = await fetch('/reservations', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reserverId: userId, bookId, startDate, dueDate })
            });

            if (response.ok) {
                alert('Book reserved successfully!');
                document.getElementById('reserveButton').style.display = 'none';
                document.getElementById('alreadyReservedMessage').style.display = 'block';
            } else {
                const error = await response.json();
                alert('Reservation failed: ' + (error.message || error));
            }
        } catch (err) {
            console.error('Reservation error:', err);
            alert('Something went wrong while reserving the book.');
        }
    });
</script>

</body>
</html>