<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <title>BookTrack - Online Library management system</title>

    <!-- Bootstrap core CSS -->
    <link href="/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">


    <!-- Additional CSS Files -->
    <link rel="stylesheet" href="/assets/css/fontawesome.css">
    <link rel="stylesheet" href="/assets/css/templatemo-scholar.css">
    <link rel="stylesheet" href="/assets/css/owl.css">
    <link rel="stylesheet" href="/assets/css/animate.css">
    <link rel="stylesheet" href="https://unpkg.com/swiper@7/swiper-bundle.min.css"/>
    <!--


    TemplateMo 586 Scholar

    https://templatemo.com/tm-586-scholar

    -->

    <style>
        .text-truncate-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .text-truncate-4 {
            display: -webkit-box;
            -webkit-line-clamp: 4;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>

</head>

<body>

<!-- ***** Preloader Start ***** -->
<div id="js-preloader" class="js-preloader">
    <div class="preloader-inner">
        <span class="dot"></span>
        <div class="dots">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </div>
</div>
<!-- ***** Preloader End ***** -->

<!-- ***** Header Area Start ***** -->
<header class="header-area header-sticky">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <nav class="main-nav">
                    <!-- ***** Logo Start ***** -->
                    <a th:href="@{/}" class="logo">
                        <h1>BookTrack</h1>
                    </a>
                    <!-- ***** Logo End ***** -->
                    <!-- ***** Serach Start ***** -->
                    <div class="search-input">
                        <form id="search" action="#">
                            <input type="text" placeholder="Type Something" id='searchText' name="searchKeyword" onkeypress="handle" />
                            <i class="fa fa-search"></i>
                        </form>
                    </div>
                    <!-- ***** Serach Start ***** -->
                    <!-- ***** Menu Start ***** -->
                    <ul class="nav">
                        <li class="scroll-to-section"><a th:href="@{/home}">Home</a></li>
                        <li class="scroll-to-section"><a href="#services">Services</a></li>
                        <li class="scroll-to-section"><a th:href="@{/library}">Books</a></li>
                        <li class="scroll-to-section"><a th:href="@{/profile}">Profile</a></li>
                        <li class="scroll-to-section"><a href="#contact">Contact Us</a></li>
                        <li class="scroll-to-section" th:if="${not #authorization.expression('isAuthenticated()')}">
                            <a th:href="@{/login}">Login</a>
                        </li>
                    </ul>
                    <a class='menu-trigger'>
                        <span>Menu</span>
                    </a>
                    <!-- ***** Menu End ***** -->
                </nav>
            </div>
        </div>
    </div>
</header>
<!-- ***** Header Area End ***** -->

<div class="main-banner" id="top">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="owl-carousel owl-banner">
                    <div class="item item-1">
                        <div class="header-text">
                            <span class="category">Our Courses</span>
                            <h2>With Scholar Teachers, Everything Is Easier</h2>
                            <p>Scholar is free CSS template designed by TemplateMo for online educational related websites. This layout is based on the famous Bootstrap v5.3.0 framework.</p>
                            <div class="buttons">
                                <div class="main-button">
                                    <a href="#">Request Demo</a>
                                </div>
                                <div class="icon-button">
                                    <a href="#"><i class="fa fa-play"></i> What's Scholar?</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="item item-2">
                        <div class="header-text">
                            <span class="category">Best Result</span>
                            <h2>Get the best result out of your effort</h2>
                            <p>You are allowed to use this template for any educational or commercial purpose. You are not allowed to re-distribute the template ZIP file on any other website.</p>
                            <div class="buttons">
                                <div class="main-button">
                                    <a href="#">Request Demo</a>
                                </div>
                                <div class="icon-button">
                                    <a href="#"><i class="fa fa-play"></i> What's the best result?</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="item item-3">
                        <div class="header-text">
                            <span class="category">Online Learning</span>
                            <h2>Online Learning helps you save the time</h2>
                            <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod temporious incididunt ut labore et dolore magna aliqua suspendisse.</p>
                            <div class="buttons">
                                <div class="main-button">
                                    <a href="#">Request Demo</a>
                                </div>
                                <div class="icon-button">
                                    <a href="#"><i class="fa fa-play"></i> What's Online Course?</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="services section" id="services">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8 col-md-10 mb-4">
                <div class="service-item">
                    <div class="row">
                        <!-- Book Image Column -->
                        <div class="col-md-4 mb-4 mb-md-0">
                            <div class="text-center">
                                <img id="bookImage" src="" alt="Book Cover" class="img-fluid rounded shadow" style="max-height: 400px; width: auto;" />
                            </div>
                        </div>
                        <!-- Book Details Column -->
                        <div class="col-md-8">
                            <div class="main-content">
                                <h4 id="bookTitle" class="text-truncate-2"></h4>
                                <h6 id="bookAuthor" class="text-muted mb-3"></h6>
                                <p id="bookDescription" class="text-truncate-4"></p>
                                <div class="mt-3">
                                    <p><strong>Category:</strong> <span id="bookCategory"></span></p>
                                    <p><strong>Published:</strong> <span id="bookYear"></span></p>
                                    <p><strong>Pages:</strong> <span id="bookPages"></span></p>
                                    <p><strong>Available:</strong> <span id="bookAvailable"></span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="mt-4">
    <h5>Leave a Review</h5>
    <form id="reviewForm">
        <div class="mb-3">
            <label for="reviewComment" class="form-label">Comment</label>
            <textarea id="reviewComment" class="form-control" rows="3" required></textarea>
        </div>
        <div class="mb-3">
            <label for="reviewRating" class="form-label">Rating (1-5)</label>
            <input type="number" id="reviewRating" class="form-control" min="1" max="5" required />
        </div>
        <button type="submit" class="btn btn-primary">Submit Review</button>
    </form>
</div>

<div id="reviewsList" class="mt-4"></div>

<footer>
    <div class="container">
        <div class="col-lg-12">
            <p>Copyright Â© 2025 Unemployed Backenders. All rights reserved.</p>
        </div>
    </div>
</footer>
<!-- Scripts -->
<!-- Bootstrap core JavaScript -->
<script src="/vendor/jquery/jquery.min.js"></script>
<script src="/vendor/bootstrap/js/bootstrap.min.js"></script>
<script src="/assets/js/isotope.min.js"></script>
<script src="/assets/js/owl-carousel.js"></script>
<script src="/assets/js/counter.js"></script>
<script src="/assets/js/custom.js"></script>
<script>
    async function fetchBookDetails() {
        const path = window.location.pathname;
        const bookId = path.split('/').pop();

        try {
            const response = await fetch(`/books/${bookId}`);
            if (!response.ok) throw new Error("Book not found");

            const book = await response.json();

            document.getElementById('bookTitle').textContent = book.title;
            document.getElementById('bookAuthor').textContent = book.author;
            document.getElementById('bookDescription').textContent = book.description;
            document.getElementById('bookYear').textContent = book.publicationYear;
            document.getElementById('bookPages').textContent = book.pages;
            document.getElementById('bookAvailable').textContent = book.available;
            document.getElementById('bookCategory').textContent = book.category;

            // Set the book image
            const bookImage = document.getElementById('bookImage');
            if (book.image) {
                bookImage.src = book.image;
                bookImage.alt = `Cover of ${book.title}`;
            } else {
                bookImage.src = '/assets/images/default-book-cover.jpg'; // fallback image
            }

            document.getElementById("js-preloader").style.display = "none";

            await loadReviews(bookId);

        } catch (err) {
            console.error(err);
            document.querySelector(".services .container").innerHTML =
                `<p class="text-danger text-center mt-5">Failed to load book details.</p>`;
        }
    }

    async function loadReviews(bookId) {
        try {
            const currentUserId = await getCurrentUserId();
            console.log("Current user ID:", currentUserId);
            const response = await fetch(`/reviews/book/${bookId}`);
            if (!response.ok) throw new Error("Reviews not found");

            const reviews = await response.json();
            const container = document.getElementById('reviewsList');
            container.innerHTML = '';

            if (reviews.length === 0) {
                container.innerHTML = '<p class="text-muted">No reviews yet.</p>';
                return;
            }

            reviews.forEach(review => {
                console.log("Full review object:", review);
                console.log("Review user ID:", review.userId);
                const div = document.createElement('div');
                div.classList.add('card', 'mb-3');

                let actionButtons = '';
                if (review.userId === currentUserId) {
                    actionButtons = `
                    <button class="btn btn-sm btn-warning me-2" onclick="editReview(${review.id}, '${review.comment}', ${review.rating})">Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteReview(${review.id})">Delete</button>
                `;
                }

                div.innerHTML = `
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-primary">${review.userName}</h6>
                    <p class="card-text">${review.comment}</p>
                    <p class="card-text"><small class="text-warning">Rating: ${review.rating} / 5</small></p>
                    ${actionButtons}
                </div>
            `;

                container.appendChild(div);
            });
        } catch (err) {
            console.error('Error loading reviews:', err);
        }
    }

    async function getCurrentUserId() {
        try {
            const response = await fetch('/users/me');
            if (!response.ok) throw new Error("User not authenticated");
            const userId = await response.json();
            return userId;
        } catch (err) {
            console.error("Failed to get user ID:", err);
            alert("You must be logged in to submit a review.");
            return null;
        }
    }
    function editReview(id, comment, rating) {
        // Pre-fill form for editing
        document.getElementById('reviewComment').value = comment;
        document.getElementById('reviewRating').value = rating;

        const submitButton = document.querySelector('#reviewForm button');
        submitButton.textContent = "Update Review";
        submitButton.classList.remove('btn-primary');
        submitButton.classList.add('btn-success');

        // Replace form submission behavior
        const form = document.getElementById('reviewForm');
        const oldHandler = form.onsubmit;
        form.onsubmit = async (e) => {
            e.preventDefault();

            const newComment = document.getElementById('reviewComment').value;
            const newRating = parseInt(document.getElementById('reviewRating').value);
            try {
                const response = await fetch(`/reviews/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ comment: newComment, rating: newRating })
                });
                if (!response.ok) throw new Error("Failed to update review");

                form.onsubmit = oldHandler; // reset form handler
                submitButton.textContent = "Submit Review";
                submitButton.classList.remove('btn-success');
                submitButton.classList.add('btn-primary');
                form.reset();
                await loadReviews(window.location.pathname.split('/').pop());
            } catch (err) {
                console.error('Update failed:', err);
                alert('Failed to update review.');
            }
        };
    }

    async function deleteReview(id) {
        if (!confirm("Are you sure you want to delete this review?")) return;

        try {
            const response = await fetch(`/reviews/${id}`, { method: 'DELETE' });
            if (!response.ok) throw new Error("Delete failed");

            await loadReviews(window.location.pathname.split('/').pop());
        } catch (err) {
            console.error("Delete failed:", err);
            alert("Failed to delete review.");
        }
    }



    document.addEventListener("DOMContentLoaded", fetchBookDetails);

    document.getElementById('reviewForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const userId = await getCurrentUserId();
        if (!userId) return; // not logged in

        const path = window.location.pathname;
        const bookId = path.split('/').pop();
        const comment = document.getElementById('reviewComment').value;
        const rating = parseInt(document.getElementById('reviewRating').value);

        try {
            const response = await fetch(`/reviews`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId, bookId, comment, rating })
            });

            if (!response.ok) throw new Error("Failed to submit review");

            // Clear the form
            document.getElementById('reviewComment').value = '';
            document.getElementById('reviewRating').value = '';

            await loadReviews(bookId); // reload reviews

        } catch (err) {
            console.error('Submit failed:', err);
            alert('Failed to submit review.');
        }
    });

</script>
</body>
</html>